[
["index.html", "R로 하는 약동학, 약력학 모델링 소개", " R로 하는 약동학, 약력학 모델링 배균섭, 한성필 2019-07-26 소개 이 자료는 Johan Gabrielsson과 Dan Weiner의 책, “Pharmacokinetic and Pharmacodynamic Data Analysis - Concepts and Applications” 5th ed. (Gabrielsson 2016)를 풀기 위한 것입니다. 서울아산병원 임상약리학과 배균섭 교수님께서 wnl패키지 (Bae 2018)를 개발하였고 기본적인 코드 또한 배교수님께서 작성하셨습니다. 오탈자 신고 등은 깃허브 저장소에 남겨주십시오. 감사합니다. 2019년 7월 가톨릭대학교 약리학교실 연구강사 한성필 References "],
["pharmacokinetics.html", "1 Pharmacokinetics 1.1 PK01.R 1.2 PK02.R 1.3 PK03.R 1.4 PK04.R 1.5 PK05.R 1.6 PK06.R", " 1 Pharmacokinetics 1.1 PK01.R require(wnl) dPK01 = read.csv(&quot;data/PK01.csv&quot;, skip=1) colnames(dPK01) = c(&quot;TIME&quot;, &quot;DV&quot;, &quot;ID&quot;) ; dPK01 TIME DV ID 10 920 1 20 800 1 30 750 1 40 630 1 50 610 1 60 530 1 70 520 1 90 380 1 110 350 1 150 200 1 10 850 2 20 630 2 30 580 2 40 410 2 50 400 2 60 270 2 70 260 2 90 145 2 110 120 2 150 42 2 10 800 3 20 680 3 30 550 3 40 465 3 50 370 3 60 320 3 70 245 3 90 185 3 110 110 3 150 60 3 10 465 4 20 400 4 30 380 4 40 330 4 50 300 4 60 290 4 70 245 4 90 215 4 110 165 4 150 120 4 ## NCA library(NonCompart) tblNCA(dPK01, key=&quot;ID&quot;, colTime=&quot;TIME&quot;, colConc=&quot;DV&quot;, dose=10, adm=&quot;Bolus&quot;) ID b0 CMAX CMAXD TMAX TLAG CLST CLSTP TLST LAMZHL LAMZ LAMZLL LAMZUL LAMZNPT CORRXY R2 R2ADJ AUCLST AUCALL AUCIFO AUCIFOD AUCIFP AUCIFPD AUCPEO AUCPEP AUMCLST AUMCIFO AUMCIFP AUMCPEO AUMCPEP C0 AUCPBEO AUCPBEP VZO VZP CLO CLP MRTIVLST MRTIVIFO MRTIVIFP VSSO VSSP 1 6.918914 920 92.0 10 NA 200 211.19414 150 66.38766 0.0104409 10 150 10 -0.9943381 0.9887083 0.9872969 77590.00 77590.00 96745.43 9674.543 97817.57 9781.757 19.799828 20.67887 4337000 9044967 9308475 52.05068 53.40805 1058.0000 10.222705 10.110658 9.899914 9.791405 0.1033641 0.1022311 55.89638 93.49244 95.16158 9.663758 9.728475 2 6.934162 850 85.0 10 NA 42 45.17696 150 33.28625 0.0208238 10 150 10 -0.9950967 0.9902174 0.9889946 48374.13 48374.13 50391.05 5039.105 50543.61 5054.361 4.002536 4.29230 1967000 2366394 2396605 16.87776 17.92557 1146.8254 19.813295 19.753490 9.529848 9.501083 0.1984480 0.1978489 40.66223 46.96061 47.41658 9.319237 9.381321 3 6.877619 800 80.0 10 NA 60 56.80923 150 36.63672 0.0189195 10 150 10 -0.9984467 0.9968957 0.9965077 48430.88 48430.88 51602.22 5160.222 51433.57 5143.357 6.145738 5.83799 2077250 2720574 2686362 23.64661 22.67423 941.1765 16.871139 16.926460 10.242896 10.276482 0.1937901 0.1944256 42.89102 52.72203 52.22974 10.217007 10.154796 4 6.207537 465 46.5 10 NA 120 117.19292 150 72.01703 0.0096248 10 150 10 -0.9971818 0.9943716 0.9936681 39677.81 39677.81 52145.65 5214.565 51853.99 5185.399 23.909634 23.48167 2245250 5410815 5336766 58.50441 57.92864 540.5625 9.641865 9.696095 19.924695 20.036761 0.1917706 0.1928492 56.58704 103.76352 102.91908 19.898788 19.847860 ### IDs = unique(dPK01[,&quot;ID&quot;]) nID = length(IDs) DOSE = 10000 # ug fPK01 = function(THETA) # Prediction function { V = THETA[1] K = THETA[2] Cp = DOSE/V*exp(-K*TIME) # External DOSE, TIME, eq 1:2 return(Cp) } Result = vector() for (i in 1:nID) { cID = IDs[i] Data = dPK01[dPK01$ID == cID,] TIME = dPK01[dPK01$ID == cID,&quot;TIME&quot;] Res = nlr(fPK01, Data, pNames=c(&quot;V&quot;, &quot;k&quot;), IE=c(20, 0.2), SecNames=c(&quot;CL&quot;, &quot;AUC&quot;, &quot;AUMC&quot; , &quot;Thalf&quot;, &quot;MRT&quot;), SecForms=c(~V*k, ~DOSE/V/k, ~DOSE/V/k/k, ~log(2)/k, ~1/k)) print(paste0(&quot;### ID = &quot;, cID, &quot; ###&quot;)) print(Res) Result = rbind(Result, cbind(ID=cID, Res$Est)) } ; Result ## [1] &quot;### ID = 1 ###&quot; ## $Est ## V k AddErrVar AddErrSD CL AUC ## PE 9.9784487 0.0102560820 432.73767 20.802348 0.10233979 97713.706554 ## SE 0.1834206 0.0003873927 193.52612 4.651545 0.00259716 2479.760540 ## RSE 1.8381673 3.7771994487 44.72135 22.360674 2.53778168 2.537782 ## AUMC Thalf MRT ## PE 9.527391e+06 67.584013 97.503121 ## SE 5.875882e+05 2.552783 3.682887 ## RSE 6.167356e+00 3.777199 3.777199 ## ## $Cov ## V k AddErrVar ## V 3.364311e-02 -5.733975e-05 1.323808e-03 ## k -5.733975e-05 1.500731e-07 -2.299946e-06 ## AddErrVar 1.323808e-03 -2.299946e-06 3.745236e+04 ## ## $run ## $run$m ## [1] 5 ## ## $run$n ## [1] 5 ## ## $run$run ## [1] 10 ## ## $run$p.value ## [1] 0.007936508 ## ## ## $`Objective Function Value` ## [1] 70.70132 ## ## $`-2LL` ## [1] 89.08009 ## ## $AIC ## [1] 95.08009 ## ## $AICc ## [1] 99.08009 ## ## $BIC ## [1] 95.98785 ## ## $Convergence ## NULL ## ## $Message ## [1] &quot;CONVERGENCE: REL_REDUCTION_OF_F &lt;= FACTR*EPSMCH&quot; ## ## $Prediction ## [1] 904.4725 816.3075 736.7365 664.9218 600.1074 541.6109 488.8164 ## [8] 398.1645 324.3242 215.1855 ## ## $Residual ## [1] 15.527485 -16.307480 13.263515 -34.921812 9.892601 -11.610884 ## [7] 31.183581 -18.164548 25.675773 -15.185498 ## ## $`Elapsed Time` ## Time difference of 0.03590393 secs ## ## [1] &quot;### ID = 2 ###&quot; ## $Est ## V k AddErrVar AddErrSD CL AUC ## PE 9.8162458 0.020661280 753.97041 27.45852 0.202816199 49305.726308 ## SE 0.3308035 0.001018768 337.18516 6.13990 0.005970426 1451.443298 ## RSE 3.3699589 4.930807431 44.72127 22.36064 2.943762128 2.943762 ## AUMC Thalf MRT ## PE 2.386383e+06 33.548124 48.399713 ## SE 1.763351e+05 1.654193 2.386497 ## RSE 7.389220e+00 4.930807 4.930807 ## ## $Cov ## V k AddErrVar ## V 0.1094309231 -2.738399e-04 1.851131e-03 ## k -0.0002738399 1.037888e-06 -4.793928e-06 ## AddErrVar 0.0018511312 -4.793928e-06 1.136938e+05 ## ## $run ## $run$m ## [1] 5 ## ## $run$n ## [1] 5 ## ## $run$run ## [1] 10 ## ## $run$p.value ## [1] 0.007936508 ## ## ## $`Objective Function Value` ## [1] 76.25355 ## ## $`-2LL` ## [1] 94.63232 ## ## $AIC ## [1] 100.6323 ## ## $AICc ## [1] 104.6323 ## ## $BIC ## [1] 101.5401 ## ## $Convergence ## NULL ## ## $Message ## [1] &quot;CONVERGENCE: REL_REDUCTION_OF_F &lt;= FACTR*EPSMCH&quot; ## ## $Prediction ## [1] 828.55965 673.89616 548.10301 445.79109 362.57728 294.89662 239.84960 ## [8] 158.66363 104.95806 45.92959 ## ## $Residual ## [1] 21.440351 -43.896160 31.896993 -35.791093 37.422718 -24.896618 ## [7] 20.150402 -13.663635 15.041938 -3.929595 ## ## $`Elapsed Time` ## Time difference of 0.002991915 secs ## ## [1] &quot;### ID = 3 ###&quot; ## $Est ## V k AddErrVar AddErrSD CL AUC ## PE 10.2230093 0.0190412124 77.05108 8.777874 0.194658492 5.137202e+04 ## SE 0.1086744 0.0003052182 34.45832 1.962794 0.001891101 4.990774e+02 ## RSE 1.0630369 1.6029348653 44.72140 22.360699 0.971496569 9.714966e-01 ## AUMC Thalf MRT ## PE 2.697939e+06 36.4024709 52.517664 ## SE 6.551250e+04 0.5835079 0.841824 ## RSE 2.428243e+00 1.6029349 1.602935 ## ## $Cov ## V k AddErrVar ## V 1.181012e-02 -2.682046e-05 2.107882e-04 ## k -2.682046e-05 9.315817e-08 -4.669132e-07 ## AddErrVar 2.107882e-04 -4.669132e-07 1.187376e+03 ## ## $run ## $run$m ## [1] 5 ## ## $run$n ## [1] 5 ## ## $run$run ## [1] 10 ## ## $run$p.value ## [1] 0.007936508 ## ## ## $`Objective Function Value` ## [1] 53.44468 ## ## $`-2LL` ## [1] 71.82345 ## ## $AIC ## [1] 77.82345 ## ## $AICc ## [1] 81.82345 ## ## $BIC ## [1] 78.7312 ## ## $Convergence ## NULL ## ## $Message ## [1] &quot;ERROR: ABNORMAL_TERMINATION_IN_LNSRCH&quot; ## ## $Prediction ## [1] 808.58617 668.39220 552.50529 456.71103 377.52574 312.06972 257.96257 ## [8] 176.26530 120.44172 56.23377 ## ## $Residual ## [1] -8.586170 11.607799 -2.505288 8.288966 -7.525742 7.930277 ## [7] -12.962573 8.734698 -10.441723 3.766227 ## ## $`Elapsed Time` ## Time difference of 0.004986048 secs ## ## [1] &quot;### ID = 4 ###&quot; ## $Est ## V k AddErrVar AddErrSD CL AUC ## PE 19.9471606 0.0098139570 72.19448 8.496733 0.195760575 51082.808630 ## SE 0.2954327 0.0003070959 32.28660 1.899942 0.004148218 1082.458078 ## RSE 1.4810766 3.1291754937 44.72170 22.360849 2.119026160 2.119026 ## AUMC Thalf MRT ## PE 5.205118e+06 70.628716 101.895699 ## SE 2.672940e+05 2.210096 3.188495 ## RSE 5.135215e+00 3.129175 3.129175 ## ## $Cov ## V k AddErrVar ## V 8.728050e-02 -7.336182e-05 4.369211e-04 ## k -7.336182e-05 9.430791e-08 -3.802700e-07 ## AddErrVar 4.369211e-04 -3.802700e-07 1.042424e+03 ## ## $run ## $run$m ## [1] 5 ## ## $run$n ## [1] 5 ## ## $run$run ## [1] 9 ## ## $run$p.value ## [1] 0.03968254 ## ## ## $`Objective Function Value` ## [1] 52.79356 ## ## $`-2LL` ## [1] 71.17233 ## ## $AIC ## [1] 77.17233 ## ## $AICc ## [1] 81.17233 ## ## $BIC ## [1] 78.08009 ## ## $Convergence ## NULL ## ## $Message ## [1] &quot;CONVERGENCE: REL_REDUCTION_OF_F &lt;= FACTR*EPSMCH&quot; ## ## $Prediction ## [1] 454.4619 411.9798 373.4689 338.5580 306.9104 278.2211 252.2137 ## [8] 207.2648 170.3267 115.0262 ## ## $Residual ## [1] 10.538139 -11.979844 6.531054 -8.557955 -6.910360 11.778892 ## [7] -7.213658 7.735151 -5.326690 4.973789 ## ## $`Elapsed Time` ## Time difference of 0.006982088 secs ## ID V k AddErrVar AddErrSD CL ## PE 1 9.9784487 0.0102560820 432.73767 20.802348 0.102339788 ## SE 1 0.1834206 0.0003873927 193.52612 4.651545 0.002597160 ## RSE 1 1.8381673 3.7771994487 44.72135 22.360674 2.537781676 ## PE 2 9.8162458 0.0206612797 753.97041 27.458522 0.202816199 ## SE 2 0.3308035 0.0010187679 337.18516 6.139900 0.005970426 ## RSE 2 3.3699589 4.9308074311 44.72127 22.360637 2.943762128 ## PE 3 10.2230093 0.0190412124 77.05108 8.777874 0.194658492 ## SE 3 0.1086744 0.0003052182 34.45832 1.962794 0.001891101 ## RSE 3 1.0630369 1.6029348653 44.72140 22.360699 0.971496569 ## PE 4 19.9471606 0.0098139570 72.19448 8.496733 0.195760575 ## SE 4 0.2954327 0.0003070959 32.28660 1.899942 0.004148218 ## RSE 4 1.4810766 3.1291754937 44.72170 22.360849 2.119026160 ## AUC AUMC Thalf MRT ## PE 9.771371e+04 9.527391e+06 67.5840131 97.503121 ## SE 2.479761e+03 5.875882e+05 2.5527830 3.682887 ## RSE 2.537782e+00 6.167356e+00 3.7771994 3.777199 ## PE 4.930573e+04 2.386383e+06 33.5481244 48.399713 ## SE 1.451443e+03 1.763351e+05 1.6541934 2.386497 ## RSE 2.943762e+00 7.389220e+00 4.9308074 4.930807 ## PE 5.137202e+04 2.697939e+06 36.4024709 52.517664 ## SE 4.990774e+02 6.551250e+04 0.5835079 0.841824 ## RSE 9.714966e-01 2.428243e+00 1.6029349 1.602935 ## PE 5.108281e+04 5.205118e+06 70.6287162 101.895699 ## SE 1.082458e+03 2.672940e+05 2.2100965 3.188495 ## RSE 2.119026e+00 5.135215e+00 3.1291755 3.129175 # Figure 1.1, p 470 plot(0, 1, type=&quot;n&quot;, xlim=c(0, 160), ylim=c(10, 1000), log=&quot;y&quot;, xlab=&quot;Time (min)&quot;, ylab=&quot;Concentration (ug/L)&quot;) for (i in 1:nID) { cID = IDs[i] TIME = dPK01[dPK01$ID == cID,&quot;TIME&quot;] points(TIME, dPK01[dPK01$ID == cID,&quot;DV&quot;], pch=14+i) cTHETA = Result[Result[,&quot;ID&quot;]==cID &amp; rownames(Result)==&quot;PE&quot;, c(&quot;V&quot;, &quot;k&quot;)] lines(TIME, fPK01(cTHETA)) } ### 1.2 PK02.R require(wnl) dPK02 = read.csv(&quot;data/PK02.csv&quot;, skip=1) colnames(dPK02) = c(&quot;TIME&quot;, &quot;DV&quot;) ; dPK02 TIME DV 10 0.00 15 0.28 20 0.55 30 1.20 40 2.00 60 1.95 90 1.85 120 1.60 180 0.86 210 0.78 240 0.60 300 0.21 360 0.18 ## NCA library(NonCompart) sNCA(dPK02[,&quot;TIME&quot;], dPK02[,&quot;DV&quot;], dose=100, doseUnit=&quot;ug&quot;, timeUnit=&quot;min&quot;) ## b0 CMAX CMAXD TMAX TLAG ## 1.557534e+00 2.000000e+00 2.000000e-02 4.000000e+01 1.000000e+01 ## CLST CLSTP TLST LAMZHL LAMZ ## 1.800000e-01 1.647689e-01 3.600000e+02 7.424929e+01 9.335405e-03 ## LAMZLL LAMZUL LAMZNPT CORRXY R2 ## 9.000000e+01 3.600000e+02 7.000000e+00 -9.822141e-01 9.647446e-01 ## R2ADJ AUCLST AUCALL AUCIFO AUCIFOD ## 9.576935e-01 3.308750e+02 3.308750e+02 3.501564e+02 3.501564e+00 ## AUCIFP AUCIFPD AUCPEO AUCPEP AUMCLST ## 3.485249e+02 3.485249e+00 5.506520e+00 5.064170e+00 4.230750e+04 ## AUMCIFO AUMCIFP AUMCPEO AUMCPEP VZFO ## 5.131423e+04 5.055210e+04 1.755210e+01 1.630912e+01 3.059178e+01 ## VZFP CLFO CLFP MRTEVLST MRTEVIFO ## 3.073499e+01 2.855866e-01 2.869236e-01 1.278655e+02 1.465466e+02 ## MRTEVIFP ## 1.450459e+02 ## attr(,&quot;units&quot;) ## [1] &quot;&quot; &quot;ug/L&quot; &quot;ug/L/ug&quot; &quot;min&quot; &quot;min&quot; ## [6] &quot;ug/L&quot; &quot;ug/L&quot; &quot;min&quot; &quot;min&quot; &quot;/min&quot; ## [11] &quot;min&quot; &quot;min&quot; &quot;&quot; &quot;&quot; &quot;&quot; ## [16] &quot;&quot; &quot;min*ug/L&quot; &quot;min*ug/L&quot; &quot;min*ug/L&quot; &quot;min*ug/L/ug&quot; ## [21] &quot;min*ug/L&quot; &quot;min*ug/L/ug&quot; &quot;%&quot; &quot;%&quot; &quot;min2*ug/L&quot; ## [26] &quot;min2*ug/L&quot; &quot;min2*ug/L&quot; &quot;%&quot; &quot;%&quot; &quot;L&quot; ## [31] &quot;L&quot; &quot;L/min&quot; &quot;L/min&quot; &quot;min&quot; &quot;min&quot; ## [36] &quot;min&quot; ## attr(,&quot;UsedPoints&quot;) ## [1] 7 8 9 10 11 12 13 ### DOSE = 100 # fPK02a = function(THETA) # Prediction function { Ka = THETA[1] V = THETA[2] K = THETA[3] Cp = DOSE/V*Ka/(Ka - K)*(exp(-K*TIME) - exp(-Ka*TIME)) # eq 2:1 return(Cp) } TIME = dPK02[,&quot;TIME&quot;] r1 = nlr(fPK02a, dPK02, pNames=c(&quot;ka&quot;, &quot;V&quot;, &quot;k&quot;), IE=c(0.1, 30, 0.05)) ; r1 ## $Est ## ka V k AddErrVar AddErrSD ## PE 0.013202142 21.017659 0.013202008 0.08701446 0.29498213 ## SE 0.005442004 8.623411 0.005441954 0.03412981 0.05785063 ## RSE 41.220611647 41.029360 41.220651532 39.22314350 19.61157175 ## ## $Cov ## ka V k AddErrVar ## ka 2.961540e-05 4.495113e-02 -2.716297e-05 7.006037e-10 ## V 4.495113e-02 7.436322e+01 -4.543926e-02 1.609271e-06 ## k -2.716297e-05 -4.543926e-02 2.961486e-05 -1.099428e-09 ## AddErrVar 7.006037e-10 1.609271e-06 -1.099428e-09 1.164844e-03 ## ## $run ## $run$m ## [1] 4 ## ## $run$n ## [1] 9 ## ## $run$run ## [1] 3 ## ## $run$p.value ## [1] 0.01818182 ## ## ## $`Objective Function Value` ## [1] -18.74183 ## ## $`-2LL` ## [1] 5.150577 ## ## $AIC ## [1] 13.15058 ## ## $AICc ## [1] 18.15058 ## ## $BIC ## [1] 15.41037 ## ## $Convergence ## NULL ## ## $Message ## [1] &quot;CONVERGENCE: REL_REDUCTION_OF_F &lt;= FACTR*EPSMCH&quot; ## ## $Prediction ## [1] 0.5504580 0.7729431 0.9647578 1.2681589 1.4817554 1.7068526 1.7229776 ## [8] 1.5460044 1.0502355 0.8245668 0.6341765 0.3590086 0.1951061 ## ## $Residual ## [1] -0.55045799 -0.49294305 -0.41475779 -0.06815889 0.51824458 ## [6] 0.24314740 0.12702241 0.05399564 -0.19023546 -0.04456675 ## [11] -0.03417646 -0.14900858 -0.01510607 ## ## $`Elapsed Time` ## Time difference of 0.01099896 secs # fPK02b = function(THETA) # Prediction function { Ka = THETA[1] V = THETA[2] K = THETA[3] tlag = THETA[4] Cp = DOSE/V*Ka/(Ka - K)*(exp(-K*(TIME - tlag)) - exp(-Ka*(TIME - tlag))) # eq 2:2 return(Cp) } TIME = dPK02[,&quot;TIME&quot;] r2 = nlr(fPK02b, dPK02, pNames=c(&quot;ka&quot;, &quot;V&quot;, &quot;k&quot;, &quot;tlag&quot;), IE=c(0.1, 30, 0.05, 20)) ; r2 # Error in WinNonlin and textbook ## $Est ## ka V k tlag AddErrVar AddErrSD ## PE 0.027469911 27.353876 0.010511280 11.375450 0.015494408 0.12447654 ## SE 0.006059932 4.148751 0.001937513 0.867595 0.006077431 0.02441195 ## RSE 22.060253988 15.166957 18.432707310 7.626907 39.223383633 19.61169182 ## ## $Cov ## ka V k tlag ## ka 3.672278e-05 2.379867e-02 -1.070816e-05 1.832660e-03 ## V 2.379867e-02 1.721213e+01 -7.768306e-03 7.847459e-01 ## k -1.070816e-05 -7.768306e-03 3.753958e-06 -3.237038e-04 ## tlag 1.832660e-03 7.847459e-01 -3.237038e-04 7.527210e-01 ## AddErrVar 9.353129e-10 6.786284e-07 -3.051212e-10 6.315332e-09 ## AddErrVar ## ka 9.353129e-10 ## V 6.786284e-07 ## k -3.051212e-10 ## tlag 6.315332e-09 ## AddErrVar 3.693517e-05 ## ## $run ## $run$m ## [1] 6 ## ## $run$n ## [1] 7 ## ## $run$run ## [1] 9 ## ## $run$p.value ## [1] 0.2668998 ## ## ## $`Objective Function Value` ## [1] -41.17464 ## ## $`-2LL` ## [1] -17.28224 ## ## $AIC ## [1] -7.282239 ## ## $AICc ## [1] 1.28919 ## ## $BIC ## [1] -4.457492 ## ## $Convergence ## NULL ## ## $Message ## [1] &quot;CONVERGENCE: REL_REDUCTION_OF_F &lt;= FACTR*EPSMCH&quot; ## ## $Prediction ## [1] -0.1417872 0.3398344 0.7359203 1.3186262 1.6855885 1.9947940 ## [7] 1.9083041 1.5908956 0.9485419 0.7087703 0.5244331 0.2828887 ## [13] 0.1512874 ## ## $Residual ## [1] 0.141787189 -0.059834410 -0.185920325 -0.118626193 0.314411475 ## [6] -0.044793970 -0.058304112 0.009104357 -0.088541869 0.071229718 ## [11] 0.075566857 -0.072888748 0.028712575 ## ## $`Elapsed Time` ## Time difference of 0.01892114 secs # Figure 2.3, p 480 plot(dPK02[,&quot;TIME&quot;], dPK02[,&quot;DV&quot;], xlim=c(0, 400), ylim=c(0, 2.5), xlab=&quot;Time (min)&quot;, ylab=&quot;Concentration (ug/L)&quot;, pch=16) TIME = 0:400 lines(TIME, fPK02a(r1$Est[&quot;PE&quot;, 1:3]), lty=2) lines(TIME, fPK02b(r2$Est[&quot;PE&quot;, 1:4])) ### 1.3 PK03.R require(wnl) dPK03 = read.csv(&quot;data/PK03.csv&quot;, skip=1) colnames(dPK03) = c(&quot;TIME&quot;, &quot;DV&quot;) ; dPK03 TIME DV 0.5 10 1.0 46 1.5 56 2.0 56 3.0 66 4.0 87 5.0 69 6.0 45 7.0 29 8.0 15 9.0 10 10.0 9 DOSE = 20000 TIME = dPK03[,&quot;TIME&quot;] fPK03a = function(THETA) # Prediction function { Ka = THETA[1] K = THETA[2] tlag = THETA[3] V = THETA[4] Cp = DOSE/V*Ka/(Ka - K)*(exp(-K*(TIME - tlag)) - exp(-Ka*(TIME - tlag))) # eq 3:2 return(Cp) } r1 = nlr(fPK03a, dPK03, pNames=c(&quot;Ka&quot;, &quot;Ke&quot;, &quot;tlag&quot;, &quot;V/F&quot;), IE=c(1, 0.5, 0.5, 300)) ; r1 ## $Est ## Ka Ke tlag V/F AddErrVar AddErrSD ## PE 0.4245171 0.4244273 0.3947633 99.35091 93.67641 9.678658 ## SE 0.1403394 0.1403091 0.1130432 32.63545 38.24656 1.975820 ## RSE 33.0585981 33.0584658 28.6356898 32.84867 40.82838 20.414190 ## ## $Cov ## Ka Ke tlag V/F ## Ka 0.0196951479 -0.017586353 1.845545e-03 4.2633350 ## Ke -0.0175863526 0.019686655 1.844896e-03 -4.4612933 ## tlag 0.0018455454 0.001844896 1.277876e-02 -0.2638356 ## V/F 4.2633349637 -4.461293287 -2.638356e-01 1065.0728668 ## AddErrVar 0.0007090489 -0.000694322 -5.160887e-05 0.1779274 ## AddErrVar ## Ka 7.090489e-04 ## Ke -6.943220e-04 ## tlag -5.160887e-05 ## V/F 1.779274e-01 ## AddErrVar 1.462799e+03 ## ## $run ## $run$m ## [1] 5 ## ## $run$n ## [1] 7 ## ## $run$run ## [1] 4 ## ## $run$p.value ## [1] 0.07575758 ## ## ## $`Objective Function Value` ## [1] 66.47711 ## ## $`-2LL` ## [1] 88.53164 ## ## $AIC ## [1] 98.53164 ## ## $AICc ## [1] 108.5316 ## ## $BIC ## [1] 100.9562 ## ## $Convergence ## NULL ## ## $Message ## [1] &quot;CONVERGENCE: REL_REDUCTION_OF_F &lt;= FACTR*EPSMCH&quot; ## ## $Prediction ## [1] 8.600438 40.004206 59.083026 69.402250 73.677645 66.692409 55.724817 ## [8] 44.365434 34.197412 25.755599 19.062323 13.917946 ## ## $Residual ## [1] 1.3995618 5.9957943 -3.0830262 -13.4022502 -7.6776447 ## [6] 20.3075910 13.2751826 0.6345664 -5.1974115 -10.7555994 ## [11] -9.0623230 -4.9179461 ## ## $`Elapsed Time` ## Time difference of 0.01698208 secs Resid1 = e$Residual fPK03b = function(THETA) # Prediction function { Tabs = THETA[1] K = THETA[2] V = THETA[3] Rin = DOSE/Tabs FT = TIME FT[FT &gt;= Tabs] = Tabs Cp = Rin/V/K * (1 - exp(-K*FT)) * exp(-K*(TIME - FT)) # eq 3:1 return(Cp) } r2 = nlr(fPK03b, dPK03, pNames=c(&quot;Tabs&quot;, &quot;ke&quot;, &quot;V&quot;), IE=c(1, 0.5, 300), SecNames=c(&quot;CL&quot;), SecForms=c(~V*ke)) ; r2 ## $Est ## Tabs ke V AddErrVar AddErrSD CL ## PE 4.5454774 0.46634453 96.135622 28.95923 5.381378 44.832321 ## SE 0.2075421 0.05486609 9.540094 11.82256 1.098470 1.849393 ## RSE 4.5659034 11.76514062 9.923579 40.82485 20.412426 4.125133 ## ## $Cov ## Tabs ke V AddErrVar ## Tabs 4.307373e-02 8.688945e-03 -1.541632080 -3.789687e-05 ## ke 8.688945e-03 3.010288e-03 -0.492884810 -9.908830e-06 ## V -1.541632e+00 -4.928848e-01 91.013399434 1.919388e-03 ## AddErrVar -3.789687e-05 -9.908830e-06 0.001919388 1.397730e+02 ## ## $run ## $run$m ## [1] 6 ## ## $run$n ## [1] 6 ## ## $run$run ## [1] 8 ## ## $run$p.value ## [1] 0.3917749 ## ## ## $`Objective Function Value` ## [1] 52.39066 ## ## $`-2LL` ## [1] 74.44519 ## ## $AIC ## [1] 82.44519 ## ## $AICc ## [1] 88.15947 ## ## $BIC ## [1] 84.38481 ## ## $Convergence ## NULL ## ## $Message ## [1] &quot;CONVERGENCE: REL_REDUCTION_OF_F &lt;= FACTR*EPSMCH&quot; ## ## $Prediction ## [1] 20.412060 36.578761 49.383066 59.524294 73.917823 82.946755 69.864600 ## [8] 43.825444 27.491312 17.245056 10.817671 6.785829 ## ## $Residual ## [1] -10.4120602 9.4212387 6.6169345 -3.5242937 -7.9178226 ## [6] 4.0532445 -0.8645999 1.1745565 1.5086882 -2.2450559 ## [11] -0.8176705 2.2141713 ## ## $`Elapsed Time` ## Time difference of 0.0219121 secs Resid2 = e$Residual # Figure 3.1 p 484 plot(dPK03[,&quot;TIME&quot;], dPK03[,&quot;DV&quot;], xlim=c(0, 10), ylim=c(0, 90), xlab=&quot;Time (h)&quot;, ylab=&quot;Concentration (ug/L)&quot;, pch=16) lines(TIME, dPK03[,&quot;DV&quot;] - Resid1) lines(TIME, dPK03[,&quot;DV&quot;] - Resid2, lty=2) ### # or # dev.new() plot(dPK03[,&quot;TIME&quot;], dPK03[,&quot;DV&quot;], xlim=c(0, 10), ylim=c(0, 90), xlab=&quot;Time (h)&quot;, ylab=&quot;Concentration (ug/L)&quot;, pch=16) lines(TIME, fPK03a(r1$Est[&quot;PE&quot;, 1:4])) lines(TIME, fPK03b(r2$Est[&quot;PE&quot;, 1:3]), lty=2) ### 1.4 PK04.R require(wnl) dPK04 = read.csv(&quot;data/PK04.csv&quot;, skip=1) colnames(dPK04) = c(&quot;TIME&quot;, &quot;DV&quot;) ; dPK04 TIME DV 1.0 0.3622 2.0 1.1400 3.0 1.7000 4.0 2.1000 5.0 2.3500 6.0 2.4000 7.0 2.5000 8.0 2.4000 10.0 2.3000 12.0 2.1000 14.0 1.7000 24.0 0.6500 216.0 0.7400 216.5 0.7000 217.0 0.7400 218.0 1.8000 219.0 2.1000 220.0 2.6000 221.0 2.6000 222.0 2.8000 223.0 2.7000 224.0 2.8000 226.0 2.4000 228.0 2.3000 230.0 1.9000 240.0 0.8000 DHPK04 = read.csv(&quot;data/PK04-dose.csv&quot;) colnames(DHPK04) = c(&quot;TIME&quot;, &quot;AMT&quot;) ; DHPK04 TIME AMT 0 352.3 24 352.3 48 352.3 72 352.3 96 352.3 120 352.3 144 352.3 168 352.3 192 352.3 216 352.3 fPK04a = function(THETA) # Eq 4:3 { V = THETA[1] Ka = THETA[2] K = THETA[3] TIME = e$DATA[,&quot;TIME&quot;] nTime = length(TIME) nDose = nrow(DHPK04) Res = matrix(rep(0, nTime*nDose), nrow=nTime, ncol=nDose) for (i in 1:nDose) { dTime = DHPK04[i,&quot;TIME&quot;] AMT = DHPK04[i,&quot;AMT&quot;] cTime = TIME &gt; dTime Res[cTime,i] = Ka * AMT / V / (Ka - K) * (exp(-K*(TIME[cTime] - dTime)) - exp(-Ka*(TIME[cTime] - dTime))) } return(rowSums(Res)) } r1 = nlr(fPK04a, dPK04, pNames=c(&quot;V/F&quot;, &quot;Ka&quot;, &quot;K&quot;), IE=c(70, 0.25, 0.1)) ; r1 ## $Est ## V/F Ka K AddErrVar AddErrSD ## PE 55.607957 0.14398602 0.1439829 0.04608985 0.21468547 ## SE 8.005242 0.02102455 0.0210241 0.01278299 0.02977144 ## RSE 14.395857 14.60180314 14.6018022 27.73493786 13.86746893 ## ## $Cov ## V/F Ka K AddErrVar ## V/F 6.408390e+01 1.573094e-01 -1.646994e-01 2.266426e-06 ## Ka 1.573094e-01 4.420319e-04 -3.917500e-04 5.516618e-09 ## K -1.646994e-01 -3.917500e-04 4.420128e-04 -5.497157e-09 ## AddErrVar 2.266426e-06 5.516618e-09 -5.497157e-09 1.634049e-04 ## ## $run ## $run$m ## [1] 11 ## ## $run$n ## [1] 15 ## ## $run$run ## [1] 10 ## ## $run$p.value ## [1] 0.09599542 ## ## ## $`Objective Function Value` ## [1] -54.00616 ## ## $`-2LL` ## [1] -6.221353 ## ## $AIC ## [1] 1.778647 ## ## $AICc ## [1] 3.683409 ## ## $BIC ## [1] 6.811033 ## ## $Convergence ## NULL ## ## $Message ## [1] &quot;CONVERGENCE: REL_REDUCTION_OF_F &lt;= FACTR*EPSMCH&quot; ## ## $Prediction ## [1] 0.7898859 1.3679263 1.7767335 2.0513009 2.2202799 2.3070517 2.3306253 ## [8] 2.3063900 2.1616205 1.9449004 1.7012998 0.6911105 0.7369004 1.1239729 ## [15] 1.4537163 1.9650326 2.3130737 2.5324349 2.6513690 2.6928659 2.6755552 ## [22] 2.6144627 2.4067010 2.1392243 1.8549232 0.7369004 ## ## $Residual ## [1] -0.427685891 -0.227926286 -0.076733524 0.048699074 0.129720077 ## [6] 0.092948335 0.169374721 0.093610021 0.138379548 0.155099571 ## [11] -0.001299785 -0.041110482 0.003099636 -0.423972875 -0.713716312 ## [16] -0.165032645 -0.213073731 0.067565140 -0.051369042 0.107134115 ## [21] 0.024444837 0.185537292 -0.006700979 0.160775739 0.045076798 ## [26] 0.063099636 ## ## $`Elapsed Time` ## Time difference of 0.2752652 secs r1 = nlr(fPK04a, dPK04, pNames=c(&quot;V/F&quot;, &quot;Ka&quot;, &quot;K&quot;), IE=c(70, 0.25, 0.1), Error=&quot;POIS&quot;) ; r1 ## $Est ## V/F Ka K PoisErrVar PoisErrSD ## PE 56.741937 0.14313883 0.14313803 0.03488885 0.18678558 ## SE 9.446503 0.02398561 0.02398543 0.00972311 0.02602747 ## RSE 16.648186 16.75688324 16.75685232 27.86881688 13.93440844 ## ## $Cov ## V/F Ka K PoisErrVar ## V/F 89.236420053 2.123464e-01 -2.219759e-01 1.251801e-03 ## Ka 0.212346351 5.753093e-04 -5.203269e-04 9.564293e-07 ## K -0.221975896 -5.203269e-04 5.753008e-04 9.543302e-07 ## PoisErrVar 0.001251801 9.564293e-07 9.543302e-07 9.453888e-05 ## ## $run ## $run$m ## [1] 9 ## ## $run$n ## [1] 17 ## ## $run$run ## [1] 8 ## ## $run$p.value ## [1] 0.02993391 ## ## ## $`Objective Function Value` ## [1] -46.90537 ## ## $`-2LL` ## [1] 0.8794381 ## ## $AIC ## [1] 8.879438 ## ## $AICc ## [1] 10.7842 ## ## $BIC ## [1] 13.91182 ## ## $Convergence ## NULL ## ## $Message ## [1] &quot;CONVERGENCE: REL_REDUCTION_OF_F &lt;= FACTR*EPSMCH&quot; ## ## $Prediction ## [1] 0.7701968 1.3349577 1.7353797 2.0052523 2.1722750 2.2590811 2.2840961 ## [8] 2.2622578 2.1238491 1.9141520 1.6772383 0.6871249 0.7336314 1.1104006 ## [15] 1.4316246 1.9303922 2.2706590 2.4858310 2.6032227 2.6450882 2.6294847 ## [22] 2.5709964 2.3698681 2.1095453 1.8319651 0.7336314 ## ## $Residual ## [1] -0.407996825 -0.194957652 -0.035379718 0.094747700 0.177724994 ## [6] 0.140918908 0.215903862 0.137742192 0.176150947 0.185847955 ## [11] 0.022761743 -0.037124855 0.006368608 -0.410400632 -0.691624633 ## [16] -0.130392159 -0.170658974 0.114169050 -0.003222716 0.154911783 ## [21] 0.070515275 0.229003590 0.030131911 0.190454697 0.068034891 ## [26] 0.066368608 ## ## $`Elapsed Time` ## Time difference of 0.2064481 secs condNum1 = sqrt(max(e$EigenVal)/min(e$EigenVal)) ; condNum1 ## [1] 13.54013 dev.new() ; plot(e$Residual, type=&quot;o&quot;) ; abline(h=0) wnl5(fPK04a, dPK04, pNames=c(&quot;V/F&quot;, &quot;Ka&quot;, &quot;K&quot;), IE=c(70, 0.25, 0.1), Error=&quot;POIS&quot;) ## $PE ## V/F Ka K ## 56.2812206 0.1427850 0.1427876 ## ## $WRSS ## [1] 0.9027653 ## ## $run ## $run$m ## [1] 10 ## ## $run$n ## [1] 16 ## ## $run$run ## [1] 6 ## ## $run$p.value ## [1] 0.001758559 ## ## ## $AIC ## [1] 3.340391 ## ## $SBC ## [1] 7.114681 ## ## $`Condition Number` ## [1] 2050.415 ## ## $Convergence ## NULL ## ## $Message ## [1] &quot;CONVERGENCE: REL_REDUCTION_OF_F &lt;= FACTR*EPSMCH&quot; ## ## $Prediction ## [1] 0.7748550 1.3435045 1.7471053 2.0195124 2.1884933 2.2767490 2.3027704 ## [8] 2.2815567 2.1434762 1.9332023 1.6951240 0.6969018 0.7444906 1.1232628 ## [15] 1.4463023 1.9481656 2.2908653 2.5078728 2.6265698 2.6692767 2.6541146 ## [22] 2.5957275 2.3939971 2.1323090 1.8529010 0.7444906 ## ## $Residual ## [1] -0.412655027 -0.203504547 -0.047105336 0.080487632 0.161506704 ## [6] 0.123250987 0.197229607 0.118443257 0.156523788 0.166797737 ## [11] 0.004876029 -0.046901782 -0.004490620 -0.423262838 -0.706302338 ## [16] -0.148165619 -0.190865341 0.092127232 -0.026569759 0.130723323 ## [21] 0.045885442 0.204272541 0.006002872 0.167691006 0.047099049 ## [26] 0.055509380 ## ## $`Elapsed Time` ## Time difference of 0.1266599 secs ## fPK04b = function(THETA) # Eq 4:4 { V = THETA[1] Ka = THETA[2] K = THETA[3] tlag = THETA[4] TIME = e$DATA[,&quot;TIME&quot;] nTime = e$nRec nDose = nrow(DHPK04) Res = matrix(rep(0, nTime*nDose), nrow=nTime, ncol=nDose) for (i in 1:nDose) { dTime = DHPK04[i,&quot;TIME&quot;] cAMT = DHPK04[i,&quot;AMT&quot;] iTime = TIME &gt; (dTime + tlag) Res[iTime,i] = Ka * cAMT / V / (Ka - K) * (exp(-K*(TIME[iTime] - dTime - tlag)) - exp(-Ka*(TIME[iTime] - dTime - tlag))) } return(rowSums(Res)) } #r2 = nlr(fPK04b, dPK04, pNames=c(&quot;V/F&quot;, &quot;Ka&quot;, &quot;K&quot;, &quot;Tlag&quot;), IE=c(70, 0.25, 0.1, 1)) ; r2 # flip-flop phenomenon r2 = nlr(fPK04b, dPK04, pNames=c(&quot;V/F&quot;, &quot;Ka&quot;, &quot;K&quot;, &quot;Tlag&quot;), IE=c(70, 0.25, 0.1, 1), LB=c(50, 0, 0, 0), Error=&quot;POIS&quot;) ; r2 ## $Est ## V/F Ka K Tlag PoisErrVar PoisErrSD ## PE 70.000000 0.2500000 0.10000000 1.000000000 1.0000000 1.0000000 ## SE 6.879036 0.2785935 0.01941813 0.006138427 0.3020087 0.1510044 ## RSE 9.827195 111.4374148 19.41813290 0.613842705 30.2008722 15.1004361 ## ## $Cov ## V/F Ka K Tlag ## V/F 47.32114060 -3.656576325 -0.0798678364 1.415231e-01 ## Ka -3.65657633 0.077614359 0.0014141040 2.676604e-03 ## K -0.07986784 0.001414104 0.0003770639 -7.481270e-05 ## Tlag 0.14152314 0.002676604 -0.0000748127 3.768029e-05 ## PoisErrVar 2.53560377 0.042480317 -0.0007041824 -6.087915e-04 ## PoisErrVar ## V/F 2.5356037698 ## Ka 0.0424803169 ## K -0.0007041824 ## Tlag -0.0006087915 ## PoisErrVar 0.0912092679 ## ## $run ## $run$m ## [1] 3 ## ## $run$n ## [1] 23 ## ## $run$run ## [1] 4 ## ## $run$p.value ## [1] 0.04384615 ## ## ## $`Objective Function Value` ## [1] 17.61469 ## ## $`-2LL` ## [1] 65.3995 ## ## $AIC ## [1] 75.3995 ## ## $AICc ## [1] 78.3995 ## ## $BIC ## [1] 81.68998 ## ## $Convergence ## NULL ## ## $Message ## [1] &quot;ERROR: ABNORMAL_TERMINATION_IN_LNSRCH&quot; ## ## $Prediction ## [1] 0.0000000 1.0572073 1.7799546 2.2517982 2.5369006 2.6844074 2.7318472 ## [8] 2.7077724 2.5262463 2.2559214 1.9607809 0.8142833 0.8981205 0.8561582 ## [15] 0.8160263 1.7982055 2.4524834 2.8619208 3.0902033 3.1860229 3.1864804 ## [22] 3.1197277 2.8642953 2.5331587 2.1880464 0.8981205 ## ## $Residual ## [1] 0.362200000 0.082792702 -0.079954593 -0.151798158 -0.186900597 ## [6] -0.284407416 -0.231847238 -0.307772434 -0.226246293 -0.155921364 ## [11] -0.260780887 -0.164283261 -0.158120535 -0.156158223 -0.076026286 ## [16] 0.001794518 -0.352483438 -0.261920818 -0.490203349 -0.386022893 ## [21] -0.486480358 -0.319727671 -0.464295322 -0.233158683 -0.288046362 ## [26] -0.098120535 ## ## $`Elapsed Time` ## Time difference of 0.2054551 secs r2 = nlr(fPK04b, dPK04, pNames=c(&quot;V/F&quot;, &quot;Ka&quot;, &quot;K&quot;, &quot;Tlag&quot;), IE=c(70, 0.25, 0.1, 1), LB=c(50, 0, 0, 0), Error=&quot;C&quot;) ; r2 ## $Est ## V/F Ka K Tlag AddErrVar PropErrVar ## PE 64.17088 0.19435146 0.12582552 0.72800905 0.005341850 1.948511e-07 ## SE 7.50410 0.02774454 0.01514092 0.05539063 0.002447779 5.600875e-04 ## RSE 11.69393 14.27544663 12.03326709 7.60850837 45.822688718 2.874438e+05 ## AddErrSD PropErrSD ## PE 0.07308796 4.414194e-04 ## SE 0.01674543 6.344165e-01 ## RSE 22.91134436 1.437219e+05 ## ## $Cov ## V/F Ka K Tlag ## V/F 56.31151666 2.057710e-01 -1.131516e-01 2.500065e-01 ## Ka 0.20577098 7.697594e-04 -4.114383e-04 9.953382e-04 ## K -0.11315163 -4.114383e-04 2.292475e-04 -4.987520e-04 ## Tlag 0.25000649 9.953382e-04 -4.987520e-04 3.068122e-03 ## AddErrVar -0.00352710 -1.375916e-05 7.474817e-06 -2.115471e-05 ## PropErrVar 0.00101268 3.950918e-06 -2.146297e-06 6.075710e-06 ## AddErrVar PropErrVar ## V/F -3.527100e-03 1.012680e-03 ## Ka -1.375916e-05 3.950918e-06 ## K 7.474817e-06 -2.146297e-06 ## Tlag -2.115471e-05 6.075710e-06 ## AddErrVar 5.991624e-06 -1.091357e-06 ## PropErrVar -1.091357e-06 3.136980e-07 ## ## $run ## $run$m ## [1] 9 ## ## $run$n ## [1] 17 ## ## $run$run ## [1] 17 ## ## $run$p.value ## [1] 0.04851259 ## ## ## $`Objective Function Value` ## [1] -110.0282 ## ## $`-2LL` ## [1] -62.24335 ## ## $AIC ## [1] -50.24335 ## ## $AICc ## [1] -45.8223 ## ## $BIC ## [1] -42.69477 ## ## $Convergence ## NULL ## ## $Message ## [1] &quot;CONVERGENCE: REL_REDUCTION_OF_F &lt;= FACTR*EPSMCH&quot; ## ## $Prediction ## [1] 0.2778516 1.1075110 1.6867323 2.0720341 2.3085001 2.4319700 2.4708239 ## [8] 2.4474335 2.2802156 2.0286872 1.7507412 0.6638664 0.7049992 0.6674099 ## [15] 0.9094643 1.6726535 2.1918139 2.5229625 2.7106952 2.7903846 2.7899680 ## [22] 2.7314016 2.5045951 2.2055793 1.8899275 0.7049992 ## ## $Residual ## [1] 0.084348432 0.032488954 0.013267708 0.027965858 0.041499874 ## [6] -0.031970005 0.029176076 -0.047433517 0.019784376 0.071312842 ## [11] -0.050741160 -0.013866415 0.035000764 0.032590063 -0.169464348 ## [16] 0.127346456 -0.091813916 0.077037472 -0.110695241 0.009615428 ## [21] -0.089968007 0.068598384 -0.104595060 0.094420657 0.010072523 ## [26] 0.095000764 ## ## $`Elapsed Time` ## Time difference of 0.3829761 secs condNum2 = sqrt(max(e$EigenVal)/min(e$EigenVal)) ; condNum2 ## [1] 39.42374 dev.new() ; plot(e$Residual, type=&quot;o&quot;) ; abline(h=0) #wnl5(fPK04b, dPK04, pNames=c(&quot;V/F&quot;, &quot;Ka&quot;, &quot;K&quot;, &quot;Tlag&quot;), IE=c(70, 0.25, 0.1, 1), Error=&quot;POIS&quot;) # fitting failure wnl5(fPK04b, dPK04, pNames=c(&quot;V/F&quot;, &quot;Ka&quot;, &quot;K&quot;, &quot;Tlag&quot;), IE=c(70, 0.25, 0.1, 1), LB=c(50, 0, 0, 0)) ## $PE ## V/F Ka K Tlag ## 64.1740936 0.1943615 0.1258195 0.7280157 ## ## $WRSS ## [1] 0.1389326 ## ## $run ## $run$m ## [1] 9 ## ## $run$n ## [1] 17 ## ## $run$run ## [1] 17 ## ## $run$p.value ## [1] 0.04851259 ## ## ## $AIC ## [1] -43.31793 ## ## $SBC ## [1] -38.28554 ## ## $`Condition Number` ## [1] 5885.296 ## ## $Convergence ## NULL ## ## $Message ## [1] &quot;CONVERGENCE: REL_REDUCTION_OF_F &lt;= FACTR*EPSMCH&quot; ## ## $Prediction ## [1] 0.2778454 1.1075058 1.6867253 2.0720242 2.3084871 2.4319543 2.4708061 ## [8] 2.4474143 2.2801959 2.0286692 1.7507265 0.6638688 0.7050054 0.6674164 ## [15] 0.9094651 1.6726556 2.1918147 2.5229607 2.7106905 2.7903772 2.7899585 ## [22] 2.7313907 2.5045833 2.2055689 1.8899197 0.7050054 ## ## $Residual ## [1] 0.084354559 0.032494245 0.013274744 0.027975768 0.041512868 ## [6] -0.031954267 0.029193930 -0.047414293 0.019804143 0.071330785 ## [11] -0.050726516 -0.013868811 0.034994622 0.032583558 -0.169465053 ## [16] 0.127344367 -0.091814675 0.077039291 -0.110690525 0.009622798 ## [21] -0.089958525 0.068609305 -0.104583282 0.094431100 0.010080262 ## [26] 0.094994622 ## ## $`Elapsed Time` ## Time difference of 0.1276579 secs ## fPK04c = function(THETA) # Eq 4:5 { V = THETA[1] Kp = THETA[2] TIME = e$DATA[,&quot;TIME&quot;] nTime = length(TIME) nDose = nrow(DHPK04) Res = matrix(rep(0, nTime*nDose), nrow=nTime, ncol=nDose) for (i in 1:nDose) { dTime = DHPK04[i,&quot;TIME&quot;] AMT = DHPK04[i,&quot;AMT&quot;] cTime = TIME &gt; dTime Res[cTime,i] = Kp * AMT / V * (TIME[cTime] - dTime) * exp(-Kp*(TIME[cTime] - dTime)) } return(rowSums(Res)) } r3 = nlr(fPK04c, dPK04, pNames=c(&quot;V/F&quot;, &quot;Kp&quot;), IE=c(70, 0.25), Error=&quot;POIS&quot;) ; r3 ## $Est ## V/F Kp PoisErrVar PoisErrSD ## PE 56.741790 0.143138503 0.03488878 0.18678538 ## SE 1.775104 0.005243002 0.00972307 0.02602738 ## RSE 3.128389 3.662887197 27.86875855 13.93437928 ## ## $Cov ## V/F Kp PoisErrVar ## V/F 3.150993794 -4.815570e-03 1.251407e-03 ## Kp -0.004815570 2.748907e-05 9.555692e-07 ## PoisErrVar 0.001251407 9.555692e-07 9.453809e-05 ## ## $run ## $run$m ## [1] 9 ## ## $run$n ## [1] 17 ## ## $run$run ## [1] 8 ## ## $run$p.value ## [1] 0.02993391 ## ## ## $`Objective Function Value` ## [1] -46.90537 ## ## $`-2LL` ## [1] 0.8794381 ## ## $AIC ## [1] 6.879438 ## ## $AICc ## [1] 7.970347 ## ## $BIC ## [1] 10.65373 ## ## $Convergence ## NULL ## ## $Message ## [1] &quot;CONVERGENCE: REL_REDUCTION_OF_F &lt;= FACTR*EPSMCH&quot; ## ## $Prediction ## [1] 0.7701970 1.3349579 1.7353799 2.0052523 2.1722749 2.2590808 2.2840957 ## [8] 2.2622572 2.1238482 1.9141510 1.6772371 0.6871239 0.7336303 1.1103996 ## [15] 1.4316237 1.9303914 2.2706582 2.4858301 2.6032218 2.6450871 2.6294835 ## [22] 2.5709951 2.3698666 2.1095437 1.8319635 0.7336303 ## ## $Residual ## [1] -0.407997000 -0.194957858 -0.035379860 0.094747681 0.177725130 ## [6] 0.140919213 0.215904336 0.137742825 0.176151848 0.185849044 ## [11] 0.022762941 -0.037123867 0.006369747 -0.410399635 -0.691623734 ## [16] -0.130391357 -0.170658173 0.114169912 -0.003221759 0.154912851 ## [21] 0.070516456 0.229004876 0.030133368 0.190456256 0.068036482 ## [26] 0.066369747 ## ## $`Elapsed Time` ## Time difference of 0.09374905 secs condNum3 = sqrt(max(e$EigenVal)/min(e$EigenVal)) ; condNum3 ## [1] 1.789674 dev.new() ; plot(e$Residual, type=&quot;o&quot;) ; abline(h=0) wnl5(fPK04c, dPK04, pNames=c(&quot;V/F&quot;, &quot;Kp&quot;), IE=c(70, 0.25), Error=&quot;POIS&quot;) ## $PE ## V/F Kp ## 56.2817680 0.1427862 ## ## $WRSS ## [1] 0.9027653 ## ## $run ## $run$m ## [1] 10 ## ## $run$n ## [1] 16 ## ## $run$run ## [1] 6 ## ## $run$p.value ## [1] 0.001758559 ## ## ## $AIC ## [1] 1.340391 ## ## $SBC ## [1] 3.856584 ## ## $`Condition Number` ## [1] 392.5461 ## ## $Convergence ## NULL ## ## $Message ## [1] &quot;CONVERGENCE: REL_REDUCTION_OF_F &lt;= FACTR*EPSMCH&quot; ## ## $Prediction ## [1] 0.7748541 1.3435031 1.7471036 2.0195105 2.1884915 2.2767474 2.3027690 ## [8] 2.2815556 2.1434756 1.9332021 1.6951242 0.6969026 0.7444916 1.1232633 ## [15] 1.4463023 1.9481650 2.2908644 2.5078718 2.6265688 2.6692758 2.6541139 ## [22] 2.5957270 2.3939971 2.1323093 1.8529016 0.7444916 ## ## $Residual ## [1] -0.412654088 -0.203503057 -0.047103576 0.080489461 0.161508463 ## [6] 0.123252585 0.197230989 0.118444393 0.156524419 0.166797912 ## [11] 0.004875837 -0.046902571 -0.004491585 -0.423263265 -0.706302336 ## [16] -0.148165032 -0.190864447 0.092128235 -0.026568785 0.130724178 ## [21] 0.045886124 0.204273020 0.006002929 0.167690685 0.047098433 ## [26] 0.055508415 ## ## $`Elapsed Time` ## Time difference of 0.03091693 secs ## fPK04d = function(THETA) # Eq 4:6 { V = THETA[1] Kp = THETA[2] tlag = THETA[3] TIME = e$DATA[,&quot;TIME&quot;] nTime = length(TIME) nDose = nrow(DHPK04) Res = matrix(rep(0, nTime*nDose), nrow=nTime, ncol=nDose) for (i in 1:nDose) { dTime = DHPK04[i,&quot;TIME&quot;] AMT = DHPK04[i,&quot;AMT&quot;] cTime = TIME &gt; (dTime + tlag) Res[cTime,i] = Kp * AMT / V * (TIME[cTime] - dTime - tlag) * exp(-Kp*(TIME[cTime] - dTime - tlag)) } return(rowSums(Res)) } r4 = nlr(fPK04d, dPK04, pNames=c(&quot;V/F&quot;, &quot;Kp&quot;, &quot;Tlag&quot;), IE=c(70, 0.25, 1), Error=&quot;POIS&quot;) ; r4 # fitting failure ## $Est ## V/F Kp Tlag PoisErrVar PoisErrSD ## PE 70.000000 0.25000000 1.00000000 1.0000000 1.0000000 ## SE 6.256067 0.02776559 0.01287795 0.2810605 0.1405302 ## RSE 8.937239 11.10623650 1.28779455 28.1060453 14.0530227 ## ## $Cov ## V/F Kp Tlag PoisErrVar ## V/F 39.1383766 -0.4896768924 0.1775572119 -7.596606121 ## Kp -0.4896769 0.0007709281 -0.0002431280 0.002627833 ## Tlag 0.1775572 -0.0002431280 0.0001658415 -0.000879759 ## PoisErrVar -7.5966061 0.0026278334 -0.0008797590 0.078994978 ## ## $run ## $run$m ## [1] 0 ## ## $run$n ## [1] 26 ## ## $run$run ## [1] 1 ## ## $run$p.value ## [1] 2.980232e-08 ## ## ## $`Objective Function Value` ## [1] 32.33672 ## ## $`-2LL` ## [1] 80.12153 ## ## $AIC ## [1] 88.12153 ## ## $AICc ## [1] 90.02629 ## ## $BIC ## [1] 93.15391 ## ## $Convergence ## NULL ## ## $Message ## [1] &quot;ERROR: ABNORMAL_TERMINATION_IN_LNSRCH&quot; ## ## $Prediction ## [1] 0.00000000 0.97989827 1.52629108 1.78301503 1.85148467 1.80242214 ## [7] 1.68447333 1.53051401 1.19353329 0.88478443 0.63422141 0.09210627 ## [13] 0.09257456 0.08346819 0.07522369 1.04091750 1.57570926 1.82297883 ## [19] 1.88375870 1.82845295 1.70544377 1.54738912 1.20442763 0.89179193 ## [25] 0.63871413 0.09257456 ## ## $Residual ## [1] 0.3622000 0.1601017 0.1737089 0.3169850 0.4985153 0.5975779 0.8155267 ## [8] 0.8694860 1.1064667 1.2152156 1.0657786 0.5578937 0.6474254 0.6165318 ## [15] 0.6647763 0.7590825 0.5242907 0.7770212 0.7162413 0.9715470 0.9945562 ## [22] 1.2526109 1.1955724 1.4082081 1.2612859 0.7074254 ## ## $`Elapsed Time` ## Time difference of 0.1186829 secs r4 = nlr(fPK04d, dPK04, pNames=c(&quot;V/F&quot;, &quot;Kp&quot;, &quot;Tlag&quot;), IE=c(70, 0.25, 1)) ; r4 ## $Est ## V/F Kp Tlag AddErrVar AddErrSD ## PE 52.2354285 0.154908191 0.69871821 0.005497434 0.07414468 ## SE 0.4796382 0.002088601 0.04489401 0.001524695 0.01028189 ## RSE 0.9182240 1.348283125 6.42519551 27.734663017 13.86733151 ## ## $Cov ## V/F Kp Tlag AddErrVar ## V/F 2.300528e-01 -5.883448e-04 -8.327242e-03 1.384452e-08 ## Kp -5.883448e-04 4.362254e-06 3.191152e-05 -1.579808e-10 ## Tlag -8.327242e-03 3.191152e-05 2.015472e-03 -1.353051e-09 ## AddErrVar 1.384452e-08 -1.579808e-10 -1.353051e-09 2.324694e-06 ## ## $run ## $run$m ## [1] 10 ## ## $run$n ## [1] 16 ## ## $run$run ## [1] 17 ## ## $run$p.value ## [1] 0.08846413 ## ## ## $`Objective Function Value` ## [1] -109.29 ## ## $`-2LL` ## [1] -61.50519 ## ## $AIC ## [1] -53.50519 ## ## $AICc ## [1] -51.60043 ## ## $BIC ## [1] -48.47281 ## ## $Convergence ## NULL ## ## $Message ## [1] &quot;CONVERGENCE: REL_REDUCTION_OF_F &lt;= FACTR*EPSMCH&quot; ## ## $Prediction ## [1] 0.3004179 1.1113439 1.6833373 2.0682745 2.3080632 2.4364355 2.4804311 ## [8] 2.4616233 2.3004550 2.0504402 1.7703590 0.6588551 0.6925678 0.6543601 ## [15] 0.9184185 1.6619164 2.1731072 2.5033543 2.6940634 2.7784825 2.7831906 ## [22] 2.7293274 2.5091507 2.2125680 1.8959191 0.6925678 ## ## $Residual ## [1] 0.0617821175 0.0286560776 0.0166626687 0.0317254993 0.0419367600 ## [6] -0.0364355398 0.0195689177 -0.0616233393 -0.0004550264 0.0495598183 ## [11] -0.0703590233 -0.0088551423 0.0474321750 0.0456398572 -0.1784185460 ## [16] 0.1380836375 -0.0731071608 0.0966456821 -0.0940634226 0.0215174948 ## [21] -0.0831906499 0.0706726458 -0.1091506813 0.0874319967 0.0040808919 ## [26] 0.1074321750 ## ## $`Elapsed Time` ## Time difference of 0.129653 secs condNum4 = sqrt(max(e$EigenVal)/min(e$EigenVal)) ; condNum4 ## [1] 2.145343 dev.new() ; plot(e$Residual, type=&quot;o&quot;) ; abline(h=0) wnl5(fPK04d, dPK04, pNames=c(&quot;V/F&quot;, &quot;Kp&quot;, &quot;Tlag&quot;), IE=c(70, 0.25, 1)) ## $PE ## V/F Kp Tlag ## 52.2354265 0.1549086 0.6987202 ## ## $WRSS ## [1] 0.1429351 ## ## $run ## $run$m ## [1] 10 ## ## $run$n ## [1] 16 ## ## $run$run ## [1] 17 ## ## $run$p.value ## [1] 0.08846413 ## ## ## $AIC ## [1] -44.57949 ## ## $SBC ## [1] -40.8052 ## ## $`Condition Number` ## [1] 287.2513 ## ## $Convergence ## NULL ## ## $Message ## [1] &quot;CONVERGENCE: REL_REDUCTION_OF_F &lt;= FACTR*EPSMCH&quot; ## ## $Prediction ## [1] 0.3004167 1.1113448 1.6833391 2.0682765 2.3080649 2.4364365 2.4804313 ## [8] 2.4616227 2.3004528 2.0504367 1.7703547 0.6588511 0.6925632 0.6543557 ## [15] 0.9184131 1.6619132 2.1731052 2.5033528 2.6940618 2.7784805 2.7831881 ## [22] 2.7293242 2.5091463 2.2125628 1.8959133 0.6925632 ## ## $Residual ## [1] 0.0617832677 0.0286551880 0.0166608595 0.0317235313 0.0419351257 ## [6] -0.0364365446 0.0195686959 -0.0616227246 -0.0004528284 0.0495632666 ## [11] -0.0703547405 -0.0088510746 0.0474367700 0.0456443194 -0.1784130674 ## [16] 0.1380868077 -0.0731051768 0.0966472454 -0.0940617802 0.0215195212 ## [21] -0.0831880755 0.0706758330 -0.1091463214 0.0874372462 0.0040866642 ## [26] 0.1074367700 ## ## $`Elapsed Time` ## Time difference of 0.06881595 secs 1.5 PK05.R require(wnl) dPK05 = read.csv(&quot;data/PK05.csv&quot;, skip=1) colnames(dPK05) = c(&quot;TIME&quot;, &quot;DV&quot;, &quot;CMT&quot;) ; dPK05 TIME DV CMT 0.5 22.10 1 1.0 21.30 1 1.5 19.00 1 2.0 18.00 1 4.0 15.10 1 6.0 12.01 1 8.0 9.10 1 12.0 6.10 1 18.0 2.95 1 24.0 1.48 1 0.5 5.02 2 1.0 8.11 2 1.5 15.50 2 2.0 20.00 2 4.0 30.60 2 6.0 45.20 2 8.0 50.00 2 12.0 63.90 2 18.0 77.00 2 24.0 85.50 2 AMT = 250 # mg ## Closed form model fPK05a = function(THETA) { V = THETA[1] Cl = THETA[2] fe = THETA[3] Div = AMT T1 = e$DATA[e$DATA[,&quot;CMT&quot;]==1,&quot;TIME&quot;] Civ = Div / V * exp(-Cl/V*T1) # Eq 5:1 T2 = e$DATA[e$DATA[,&quot;CMT&quot;]==2,&quot;TIME&quot;] Xu = fe * Div * (1 - exp(-Cl/V*T2)) # Eq 5:2 return(c(Civ, Xu)) } nlr(fPK05a, dPK05, pNames=c(&quot;V&quot;, &quot;Cl&quot;, &quot;fe&quot;), IE=c(10.5, 1.15, 0.3), Error=&quot;P&quot;) ## $Est ## V Cl fe PropErrVar PropErrSD ## PE 10.7193442 1.23017818 0.353887499 3.097324e-03 0.055653605 ## SE 0.2632914 0.02175472 0.007773822 9.824817e-04 0.008826757 ## RSE 2.4562265 1.76841998 2.196692996 3.172034e+01 15.860170553 ## ## $Cov ## V Cl fe PropErrVar ## V 0.0693223475 3.568639e-03 8.537628e-04 1.026780e-05 ## Cl 0.0035686393 4.732677e-04 -1.286837e-05 1.176198e-06 ## fe 0.0008537628 -1.286837e-05 6.043231e-05 -3.398593e-07 ## PropErrVar 0.0000102678 1.176198e-06 -3.398593e-07 9.652702e-07 ## ## $run ## $run$m ## [1] 10 ## ## $run$n ## [1] 10 ## ## $run$run ## [1] 13 ## ## $run$p.value ## [1] 0.2422113 ## ## ## $`Objective Function Value` ## [1] 16.95298 ## ## $`-2LL` ## [1] 53.71052 ## ## $AIC ## [1] 61.71052 ## ## $AICc ## [1] 64.37719 ## ## $BIC ## [1] 65.69345 ## ## $Convergence ## NULL ## ## $Message ## [1] &quot;CONVERGENCE: REL_REDUCTION_OF_F &lt;= FACTR*EPSMCH&quot; ## ## $Prediction ## [1] 22.021731 20.793668 19.634089 18.539175 14.736997 11.714604 9.312069 ## [8] 5.884146 2.955556 1.484551 4.933719 9.592305 13.991100 18.144593 ## [15] 32.567932 44.033206 53.147080 66.150710 77.260144 82.840318 ## ## $Residual ## [1] 0.078269463 0.506332498 -0.634088585 -0.539174705 0.363002805 ## [6] 0.295396207 -0.212069496 0.215854326 -0.005556238 -0.004550716 ## [11] 0.086280603 -1.482305176 1.508899573 1.855407381 -1.967932104 ## [16] 1.166794122 -3.147080154 -2.250710016 -0.260143898 2.659682119 ## ## $`Elapsed Time` ## Time difference of 0.04088998 secs wnl5(fPK05a, dPK05, pNames=c(&quot;V&quot;, &quot;Cl&quot;, &quot;fe&quot;), IE=c(10.5, 1.15, 0.3), Error=&quot;PROP&quot;) ## $PE ## V Cl fe ## 10.9350649 1.1685112 0.3632237 ## ## $WRSS ## [1] 30.51082 ## ## $run ## $run$m ## [1] 8 ## ## $run$n ## [1] 12 ## ## $run$run ## [1] 11 ## ## $run$p.value ## [1] 0.5200048 ## ## ## $AIC ## [1] 74.36163 ## ## $SBC ## [1] 77.34883 ## ## $`Condition Number` ## [1] 107.8311 ## ## $Convergence ## NULL ## ## $Message ## [1] &quot;CONVERGENCE: REL_REDUCTION_OF_F &lt;= FACTR*EPSMCH&quot; ## ## $Prediction ## [1] 21.672773 20.545198 19.476287 18.462989 14.910265 12.041171 9.724160 ## [8] 6.341892 3.340172 1.759215 4.724385 9.202973 13.448552 17.473245 ## [15] 31.584217 42.979898 52.182776 65.616720 77.539172 83.818535 ## ## $Residual ## [1] 0.42722694 0.75480235 -0.47628693 -0.46298872 0.18973489 ## [6] -0.03117108 -0.62415982 -0.24189154 -0.39017249 -0.27921524 ## [11] 0.29561524 -1.09297264 2.05144822 2.52675501 -0.98421690 ## [16] 2.22010196 -2.18277572 -1.71672049 -0.53917155 1.68146484 ## ## $`Elapsed Time` ## Time difference of 0.01196885 secs ## Differential Equation Model require(deSolve) ivPK1c = function(t, y, p) { dy1dt = -p[&quot;Cl&quot;]/p[&quot;V&quot;]*y[1] # Eq 5:3 dy2dt = p[&quot;fe&quot;]*p[&quot;Cl&quot;]*y[1] # Eq 5:4 return(list(c(dy1dt, dy2dt))) } Times = c(0, dPK05[dPK05[,&quot;CMT&quot;]==1,&quot;TIME&quot;]) lsoda(y=c(AMT/10.72, 0), times=Times, func=ivPK1c, parms=c(V=10.72, Cl=1.23, fe=0.3539)) ## time 1 2 ## 1 0.0 23.320896 0.000000 ## 2 0.5 22.020644 4.932904 ## 3 1.0 20.792888 9.590777 ## 4 1.5 19.633584 13.988951 ## 5 2.0 18.538917 18.141907 ## 6 4.0 14.737491 32.563789 ## 7 6.0 11.715553 44.028442 ## 8 8.0 9.313266 53.142258 ## 9 12.0 5.885456 66.146709 ## 10 18.0 2.956632 77.258104 ## 11 24.0 1.485301 82.840054 iTime = 2:length(Times) fPK05b = function(THETA) { Fs = lsoda(y=c(AMT/THETA[1],0), times=Times, func=ivPK1c, parms=c(V=THETA[1], Cl=THETA[2], fe=THETA[3])) return(c(Fs[iTime,2], Fs[iTime,3])) } nlr(fPK05b, dPK05, pNames=c(&quot;V&quot;, &quot;Cl&quot;, &quot;fe&quot;), IE=c(10.5, 1.15, 0.3), Error=&quot;P&quot;) ## $Est ## V Cl fe PropErrVar PropErrSD ## PE 10.7193471 1.23017814 0.353887576 3.097332e-03 0.055653679 ## SE 0.2632917 0.02175473 0.007773823 9.824881e-04 0.008826803 ## RSE 2.4562286 1.76842129 2.196692928 3.172046e+01 15.860232326 ## ## $Cov ## V Cl fe PropErrVar ## V 6.932251e-02 3.568669e-03 8.537612e-04 1.026772e-05 ## Cl 3.568669e-03 4.732684e-04 -1.286797e-05 1.176221e-06 ## fe 8.537612e-04 -1.286797e-05 6.043233e-05 -3.398843e-07 ## PropErrVar 1.026772e-05 1.176221e-06 -3.398843e-07 9.652829e-07 ## ## $run ## $run$m ## [1] 10 ## ## $run$n ## [1] 10 ## ## $run$run ## [1] 13 ## ## $run$p.value ## [1] 0.2422113 ## ## ## $`Objective Function Value` ## [1] 16.95296 ## ## $`-2LL` ## [1] 53.7105 ## ## $AIC ## [1] 61.7105 ## ## $AICc ## [1] 64.37717 ## ## $BIC ## [1] 65.69343 ## ## $Convergence ## NULL ## ## $Message ## [1] &quot;CONVERGENCE: REL_REDUCTION_OF_F &lt;= FACTR*EPSMCH&quot; ## ## $Prediction ## [1] 22.021726 20.793663 19.634085 18.539171 14.736997 11.714607 9.312074 ## [8] 5.884148 2.955556 1.484550 4.933716 9.592302 13.991098 18.144590 ## [15] 32.567925 44.033192 53.147065 66.150711 77.260157 82.840337 ## ## $Residual ## [1] 0.078274381 0.506336827 -0.634084744 -0.539171358 0.363003090 ## [6] 0.295393135 -0.212074064 0.215852320 -0.005556313 -0.004549972 ## [11] 0.086283537 -1.482302281 1.508902169 1.855409821 -1.967925097 ## [16] 1.166808262 -3.147064793 -2.250710727 -0.260157360 2.659662818 ## ## $`Elapsed Time` ## Time difference of 0.229387 secs wnl5(fPK05b, dPK05, pNames=c(&quot;V&quot;, &quot;Cl&quot;, &quot;fe&quot;), IE=c(10.5, 1.15, 0.3), Error=&quot;PROP&quot;) ## $PE ## V Cl fe ## 10.9350651 1.1685117 0.3632237 ## ## $WRSS ## [1] 30.51068 ## ## $run ## $run$m ## [1] 8 ## ## $run$n ## [1] 12 ## ## $run$run ## [1] 11 ## ## $run$p.value ## [1] 0.5200048 ## ## ## $AIC ## [1] 74.36153 ## ## $SBC ## [1] 77.34873 ## ## $`Condition Number` ## [1] 107.831 ## ## $Convergence ## NULL ## ## $Message ## [1] &quot;CONVERGENCE: REL_REDUCTION_OF_F &lt;= FACTR*EPSMCH&quot; ## ## $Prediction ## [1] 21.672773 20.545197 19.476286 18.462987 14.910263 12.041172 9.724161 ## [8] 6.341900 3.340168 1.759213 4.724384 9.202973 13.448555 17.473249 ## [15] 31.584227 42.979896 52.182771 65.616689 77.539190 83.818547 ## ## $Residual ## [1] 0.42722705 0.75480280 -0.47628602 -0.46298750 0.18973740 ## [6] -0.03117174 -0.62416125 -0.24189967 -0.39016823 -0.27921269 ## [11] 0.29561601 -1.09297339 2.05144549 2.52675091 -0.98422660 ## [16] 2.22010449 -2.18277050 -1.71668912 -0.53918976 1.68145317 ## ## $`Elapsed Time` ## Time difference of 0.08577085 secs 1.6 PK06.R library(tidyverse) require(wnl) dPK06 = read.csv(&quot;data/PK06.csv&quot;, skip=1) colnames(dPK06) = c(&quot;TIME&quot;, &quot;DV&quot;, &quot;CMT&quot;) ; dPK06 TIME DV CMT 0.3330 47.50 1 0.6667 46.20 1 1.0000 46.50 1 2.0000 42.90 1 3.0000 45.90 1 4.0000 44.80 1 6.0000 40.50 1 8.0000 38.00 1 24.0000 26.30 1 48.0000 14.20 1 72.0000 8.80 1 96.0000 5.70 1 168.0000 1.50 1 0.3330 0.94 2 0.6667 13.10 2 1.0000 27.90 2 2.0000 38.00 2 3.0000 71.90 2 4.0000 76.10 2 6.0000 83.90 2 8.0000 75.00 2 24.0000 51.60 2 48.0000 34.90 2 72.0000 23.40 2 96.0000 14.50 2 168.0000 4.50 2 24.0000 340.00 3 48.0000 550.00 3 24.0000 705.00 4 48.0000 1210.00 4 # concentration-time plot dPK06 %&gt;% filter(CMT %in% c(1,2)) %&gt;% ggplot(aes(x=TIME, y=DV, group = CMT, color = as.factor(CMT))) + geom_line() Div = 12500 Dpo = 25000 # Numbers in Table 6.2 p502 # Error ? Au,po/Dpo / Au,iv/Div = 1.10 (110 %) Data error ??? # &gt; 586*1204 # [1] 705544 # &gt; 447.5*1128 # [1] 504780 # &gt; 394*863 # [1] 340022 # &gt; 132*1591 # [1] 210012 ## Fitting IV and urine data only dPK06a = dPK06[dPK06[,&quot;CMT&quot;] == 1 | dPK06[,&quot;CMT&quot;] == 3,] ; dPK06a # IV data only TIME DV CMT 1 0.3330 47.5 1 2 0.6667 46.2 1 3 1.0000 46.5 1 4 2.0000 42.9 1 5 3.0000 45.9 1 6 4.0000 44.8 1 7 6.0000 40.5 1 8 8.0000 38.0 1 9 24.0000 26.3 1 10 48.0000 14.2 1 11 72.0000 8.8 1 12 96.0000 5.7 1 13 168.0000 1.5 1 27 24.0000 340.0 3 28 48.0000 550.0 3 fPK06a = function(THETA) { V = THETA[1] Cl = THETA[2] fe = THETA[3] T1 = e$DATA[e$DATA[,&quot;CMT&quot;]==1,&quot;TIME&quot;] Civ = Div/V*exp(-Cl/V*T1) # Eq 6:1 T2 = e$DATA[e$DATA[,&quot;CMT&quot;]==3,&quot;TIME&quot;] Xu = fe*Div*(1 - exp(-Cl/V*T2)) # Eq 6:2 return(c(Civ, Xu)) } nlr(fPK06a, dPK06a, pNames=c(&quot;V&quot;, &quot;Cl&quot;, &quot;fe&quot;), IE=c(300, 5, 0.2)) ## $Est ## V Cl fe AddErrVar AddErrSD ## PE 268.332192 5.5935178 0.069447641 2.3773647 1.5418705 ## SE 3.309976 0.1393167 0.001104786 0.8680582 0.2814952 ## RSE 1.233537 2.4906809 1.590818015 36.5134633 18.2567317 ## ## $Cov ## V Cl fe AddErrVar ## V 10.9559381164 1.190155e-01 8.619586e-04 -4.197039e-04 ## Cl 0.1190155209 1.940914e-02 -1.334176e-04 3.895486e-05 ## fe 0.0008619586 -1.334176e-04 1.220551e-06 -3.811515e-07 ## AddErrVar -0.0004197039 3.895486e-05 -3.811515e-07 7.535250e-01 ## ## $run ## $run$m ## [1] 7 ## ## $run$n ## [1] 8 ## ## $run$run ## [1] 7 ## ## $run$p.value ## [1] 0.2960373 ## ## ## $`Objective Function Value` ## [1] 27.99045 ## ## $`-2LL` ## [1] 55.55861 ## ## $AIC ## [1] 63.55861 ## ## $AICc ## [1] 67.55861 ## ## $BIC ## [1] 66.39081 ## ## $Convergence ## NULL ## ## $Message ## [1] &quot;CONVERGENCE: REL_REDUCTION_OF_F &lt;= FACTR*EPSMCH&quot; ## ## $Prediction ## [1] 46.261803 45.941116 45.623033 44.681842 43.760067 42.857309 ## [7] 41.107279 39.428709 28.246407 17.127311 10.385207 6.297108 ## [13] 1.403845 341.722652 548.927422 ## ## $Residual ## [1] 1.23819669 0.25888371 0.87696731 -1.78184179 2.13993260 ## [6] 1.94269103 -0.60727890 -1.42870935 -1.94640709 -2.92731136 ## [11] -1.58520735 -0.59710813 0.09615523 -1.72265228 1.07257839 ## ## $`Elapsed Time` ## Time difference of 0.0538559 secs wnl5(fPK06a, dPK06a, pNames=c(&quot;V&quot;, &quot;Cl&quot;, &quot;fe&quot;), IE=c(300, 5, 0.2)) ## $PE ## V Cl fe ## 268.33271003 5.59350948 0.06944777 ## ## $WRSS ## [1] 35.66182 ## ## $run ## $run$m ## [1] 7 ## ## $run$n ## [1] 8 ## ## $run$run ## [1] 7 ## ## $run$p.value ## [1] 0.2960373 ## ## ## $AIC ## [1] 59.61121 ## ## $SBC ## [1] 61.73536 ## ## $`Condition Number` ## [1] 19989.33 ## ## $Convergence ## NULL ## ## $Message ## [1] &quot;CONVERGENCE: REL_REDUCTION_OF_F &lt;= FACTR*EPSMCH&quot; ## ## $Prediction ## [1] 46.261715 45.941030 45.622948 44.681762 43.759992 42.857238 ## [7] 41.107217 39.428656 28.246401 17.127337 10.385241 6.297139 ## [13] 1.403859 341.722389 548.927353 ## ## $Residual ## [1] 1.23828493 0.25897024 0.87705216 -1.78176188 2.14000774 ## [6] 1.94276156 -0.60721712 -1.42865572 -1.94640092 -2.92733695 ## [11] -1.58524065 -0.59713911 0.09614111 -1.72238884 1.07264672 ## ## $`Elapsed Time` ## Time difference of 0.01894999 secs ## Fitting Oral and urine data only dPK06b = dPK06[dPK06[,&quot;CMT&quot;] == 2 | dPK06[,&quot;CMT&quot;] == 4,] ; dPK06b # oral data only TIME DV CMT 14 0.3330 0.94 2 15 0.6667 13.10 2 16 1.0000 27.90 2 17 2.0000 38.00 2 18 3.0000 71.90 2 19 4.0000 76.10 2 20 6.0000 83.90 2 21 8.0000 75.00 2 22 24.0000 51.60 2 23 48.0000 34.90 2 24 72.0000 23.40 2 25 96.0000 14.50 2 26 168.0000 4.50 2 29 24.0000 705.00 4 30 48.0000 1210.00 4 fPK06b = function(THETA) { V = THETA[1] Cl = THETA[2] fe = THETA[3] Fo = THETA[4] # BA for oral Ka = THETA[5] Tlag = THETA[6] ke = Cl/V T1 = e$DATA[e$DATA[,&quot;CMT&quot;]==2,&quot;TIME&quot;] Cpo = Ka*Fo*Dpo/V/(Ka - ke)*(exp(-ke*(T1 - Tlag)) - exp(-Ka*(T1 - Tlag))) # Eq 6:3 Cpo[Cpo &lt; 0] = 0 T2 = e$DATA[e$DATA[,&quot;CMT&quot;]==4,&quot;TIME&quot;] Xu = fe*Ka*Fo*Dpo*(1/Ka + exp(-ke*(T2 - Tlag))/(ke - Ka) - ke*exp(-Ka*(T2 - Tlag))/Ka/(ke - Ka)) # Erratum in Eq 6:4, See Gibaldi 2e eq 1.122 p39 or WinNonlin model file return(c(Cpo, Xu)) } #fPK06b(c(300, 5, 0.2, 0.9, 1, 0.4)) # fe &amp; Fo are identifiable? #fPK06b(c(300, 5, 0.9, 0.2, 1, 0.4)) # Difficult to fit nlr(fPK06b, dPK06b, pNames=c(&quot;V&quot;, &quot;Cl&quot;, &quot;fe&quot;, &quot;F&quot;, &quot;Ka&quot;, &quot;Tlag&quot;), IE=c(300, 5, 0.2, 0.9, 1, 0.4), LB=c(30, 0.5, 0.02, 0.09, 0.1, 0.04), UB=c(3000, 50, 2, 9, 10, 1)) ## $Est ## V Cl fe F Ka Tlag ## PE 199.29724 3.849105 0.11663214 0.7072763 0.53075442 0.3740187 ## SE 81.65549 1.557666 0.04706385 0.2865555 0.08341857 0.1161189 ## RSE 40.97171 40.468269 40.35238958 40.5153485 15.71698101 31.0462828 ## AddErrVar AddErrSD ## PE 21.547839 4.6419649 ## SE 7.859504 0.8465708 ## RSE 36.474674 18.2373372 ## ## $Cov ## V Cl fe F ## V 6667.6184462 126.149483135 -3.788976e+00 23.2612066988 ## Cl 126.1494831 2.426323653 -7.306783e-02 0.4440699282 ## fe -3.7889762 -0.073067835 2.215006e-03 -0.0134441879 ## F 23.2612067 0.444069928 -1.344419e-02 0.0821140279 ## Ka 0.8803313 0.006263374 -2.323086e-05 0.0011910180 ## Tlag 0.4335629 0.003252393 -1.013035e-05 0.0005590531 ## AddErrVar -2.4923656 -0.025913916 5.022292e-06 -0.0020027005 ## Ka Tlag AddErrVar ## V 8.803313e-01 4.335629e-01 -2.492366e+00 ## Cl 6.263374e-03 3.252393e-03 -2.591392e-02 ## fe -2.323086e-05 -1.013035e-05 5.022292e-06 ## F 1.191018e-03 5.590531e-04 -2.002701e-03 ## Ka 6.958658e-03 6.234743e-03 -3.233696e-02 ## Tlag 6.234743e-03 1.348360e-02 -5.956220e-02 ## AddErrVar -3.233696e-02 -5.956220e-02 6.177180e+01 ## ## $run ## $run$m ## [1] 6 ## ## $run$n ## [1] 9 ## ## $run$run ## [1] 9 ## ## $run$p.value ## [1] 0.4335664 ## ## ## $`Objective Function Value` ## [1] 61.10464 ## ## $`-2LL` ## [1] 88.67279 ## ## $AIC ## [1] 102.6728 ## ## $AICc ## [1] 118.6728 ## ## $BIC ## [1] 107.6291 ## ## $Convergence ## NULL ## ## $Message ## [1] &quot;NEW_X&quot; ## ## $Prediction ## [1] 0.000000 12.728064 24.920986 50.380579 64.671608 ## [6] 72.406792 77.943247 77.854274 58.338578 36.698942 ## [11] 23.086006 14.522590 3.615179 706.222327 1209.231400 ## ## $Residual ## [1] 0.94000000 0.37193601 2.97901356 -12.38057907 7.22839225 ## [6] 3.69320775 5.95675277 -2.85427424 -6.73857756 -1.79894246 ## [11] 0.31399379 -0.02258967 0.88482069 -1.22232686 0.76860024 ## ## $`Elapsed Time` ## Time difference of 0.1546159 secs nlr(fPK06b, dPK06b, pNames=c(&quot;V&quot;, &quot;Cl&quot;, &quot;fe&quot;, &quot;F&quot;, &quot;Ka&quot;, &quot;Tlag&quot;), IE=c(300, 5, 0.2, 0.9, 1, 0.4), LB=c(200, 3, 0.01, 0.09, 0.1, 0), UB=c(400, 10, 0.3, 1, 5, 1)) ## $Est ## V Cl fe F Ka Tlag ## PE 259.8127 5.008762 0.08983765 0.9190082 0.54181929 0.3939449 ## SE 349.6771 6.735147 0.12076177 1.2356310 0.08430551 0.1105221 ## RSE 134.5881 134.467306 134.42223441 134.4526619 15.55971012 28.0552262 ## AddErrVar AddErrSD ## PE 21.593051 4.6468324 ## SE 7.892074 0.8491885 ## RSE 36.549136 18.2745679 ## ## $Cov ## V Cl fe F ## V 1.222740e+05 2.353369e+03 -4.217393e+01 431.840257321 ## Cl 2.353369e+03 4.536220e+01 -8.131060e-01 8.318259674 ## fe -4.217393e+01 -8.131060e-01 1.458341e-02 -0.149175005 ## F 4.318403e+02 8.318260e+00 -1.491750e-01 1.526783962 ## Ka 1.102843e+00 7.359042e-03 -3.051345e-06 0.001390045 ## Tlag 4.912299e-01 3.567995e-03 -1.898847e-06 0.000593370 ## AddErrVar -4.217686e-02 5.781229e-04 -3.198396e-06 -0.000141747 ## Ka Tlag AddErrVar ## V 1.102843e+00 4.912299e-01 -4.217686e-02 ## Cl 7.359042e-03 3.567995e-03 5.781229e-04 ## fe -3.051345e-06 -1.898847e-06 -3.198396e-06 ## F 1.390045e-03 5.933700e-04 -1.417470e-04 ## Ka 7.107419e-03 5.822442e-03 -2.029937e-05 ## Tlag 5.822442e-03 1.221514e-02 1.697367e-04 ## AddErrVar -2.029937e-05 1.697367e-04 6.228483e+01 ## ## $run ## $run$m ## [1] 6 ## ## $run$n ## [1] 9 ## ## $run$run ## [1] 9 ## ## $run$p.value ## [1] 0.4335664 ## ## ## $`Objective Function Value` ## [1] 61.07151 ## ## $`-2LL` ## [1] 88.63967 ## ## $AIC ## [1] 102.6397 ## ## $AICc ## [1] 118.6397 ## ## $BIC ## [1] 107.596 ## ## $Convergence ## NULL ## ## $Message ## [1] &quot;CONVERGENCE: REL_REDUCTION_OF_F &lt;= FACTR*EPSMCH&quot; ## ## $Prediction ## [1] 0.000000 12.116053 24.600088 50.489579 64.858401 ## [6] 72.538967 77.902170 77.698733 58.168780 36.622860 ## [11] 23.057523 14.516872 3.622882 706.317354 1209.225583 ## ## $Residual ## [1] 0.94000000 0.98394702 3.29991158 -12.48957853 7.04159936 ## [6] 3.56103330 5.99783011 -2.69873256 -6.56877969 -1.72286006 ## [11] 0.34247683 -0.01687207 0.87711759 -1.31735366 0.77441702 ## ## $`Elapsed Time` ## Time difference of 0.1126981 secs wnl5(fPK06b, dPK06b, pNames=c(&quot;V&quot;, &quot;Cl&quot;, &quot;fe&quot;, &quot;F&quot;, &quot;Ka&quot;, &quot;Tlag&quot;), IE=c(300, 5, 0.2, 0.9, 1, 0.4), LB=c(200, 3, 0.01, 0.09, 0.1, 0), UB=c(400, 10, 0.3, 1, 5, 1)) ## $PE ## V Cl fe F Ka ## 257.35673553 4.96104921 0.09069824 0.91033578 0.54179643 ## Tlag ## 0.39387088 ## ## $WRSS ## [1] 323.592 ## ## $run ## $run$m ## [1] 6 ## ## $run$n ## [1] 9 ## ## $run$run ## [1] 9 ## ## $run$p.value ## [1] 0.4335664 ## ## ## $AIC ## [1] 98.69225 ## ## $SBC ## [1] 102.9406 ## ## $`Condition Number` ## [1] 5143999 ## ## $Convergence ## NULL ## ## $Message ## [1] &quot;CONVERGENCE: REL_REDUCTION_OF_F &lt;= FACTR*EPSMCH&quot; ## ## $Prediction ## [1] 0.000000 12.118821 24.602142 50.490547 64.859143 ## [6] 72.539828 77.903497 77.700449 58.171525 36.625837 ## [11] 23.060183 14.519042 3.623794 706.312290 1209.233243 ## ## $Residual ## [1] 0.94000000 0.98117947 3.29785790 -12.49054701 7.04085685 ## [6] 3.56017229 5.99650337 -2.70044899 -6.57152491 -1.72583681 ## [11] 0.33981675 -0.01904169 0.87620563 -1.31229011 0.76675708 ## ## $`Elapsed Time` ## Time difference of 0.05784583 secs ## Fitting both IV and oral data fPK06c = function(THETA) { V = THETA[1] Cl = THETA[2] fe = THETA[3] Fo = THETA[4] # BA for oral Ka = THETA[5] Tlag = THETA[6] ke = Cl/V T1 = e$DATA[e$DATA[,&quot;CMT&quot;]==1,&quot;TIME&quot;] Civ = Div/V*exp(-Cl/V*T1) # Eq 6:1 T2 = e$DATA[e$DATA[,&quot;CMT&quot;]==2,&quot;TIME&quot;] Cpo = Ka*Fo*Dpo/V/(Ka - ke)*(exp(-ke*(T2 - Tlag)) - exp(-Ka*(T2 - Tlag))) # Eq 6:3 Cpo[Cpo &lt; 0] = 0 T3 = e$DATA[e$DATA[,&quot;CMT&quot;]==3,&quot;TIME&quot;] Xuiv = fe*Div*(1 - exp(-Cl/V*T3)) # Eq 6:2 T4 = e$DATA[e$DATA[,&quot;CMT&quot;]==4,&quot;TIME&quot;] Xupo = fe*Ka*Fo*Dpo*(1/Ka + exp(-ke*(T4 - Tlag))/(ke - Ka) - ke*exp(-Ka*(T4 - Tlag))/Ka/(ke - Ka)) # Erratum in Eq 6:4, See Gibaldi 2e eq 1.122 p39 or WinNonlin model file return(c(Civ, Cpo, Xuiv, Xupo)) } nlr(fPK06c, dPK06, pNames=c(&quot;V&quot;, &quot;Cl&quot;, &quot;fe&quot;, &quot;F&quot;, &quot;Ka&quot;, &quot;Tlag&quot;), IE=c(300, 5, 0.2, 0.9, 1, 0.4)) ## $Est ## V Cl fe F Ka Tlag ## PE 288.890097 6.0387583 0.069506317 1.136733588 0.40864810 0.26951444 ## SE 8.171914 0.1974753 0.001860179 0.009971791 0.04695062 0.08928057 ## RSE 2.828728 3.2701317 2.676273602 0.877232013 11.48925475 33.12645122 ## AddErrVar AddErrSD ## PE 18.012465 4.2441095 ## SE 4.504702 0.5307005 ## RSE 25.008803 12.5044013 ## ## $Cov ## V Cl fe F ## V 66.780172963 0.2128813650 8.239156e-03 -1.947950e-02 ## Cl 0.212881365 0.0389965130 -2.672023e-04 4.783702e-04 ## fe 0.008239156 -0.0002672023 3.460267e-06 -9.960331e-06 ## F -0.019479501 0.0004783702 -9.960331e-06 9.943661e-05 ## Ka 0.246261709 -0.0022478867 5.557970e-05 -2.621633e-04 ## Tlag 0.167722779 -0.0016627015 3.881372e-05 -1.884649e-04 ## AddErrVar -1.802658315 0.0185673023 -4.235451e-04 1.224641e-03 ## Ka Tlag AddErrVar ## V 0.2462617086 1.677228e-01 -1.8026583147 ## Cl -0.0022478867 -1.662702e-03 0.0185673023 ## fe 0.0000555797 3.881372e-05 -0.0004235451 ## F -0.0002621633 -1.884649e-04 0.0012246410 ## Ka 0.0022043609 2.560869e-03 -0.0159226181 ## Tlag 0.0025608695 7.971020e-03 -0.0538420507 ## AddErrVar -0.0159226181 -5.384205e-02 20.2923391532 ## ## $run ## $run$m ## [1] 12 ## ## $run$n ## [1] 18 ## ## $run$run ## [1] 11 ## ## $run$p.value ## [1] 0.06510955 ## ## ## $`Objective Function Value` ## [1] 118.0447 ## ## $`-2LL` ## [1] 173.181 ## ## $AIC ## [1] 187.181 ## ## $AICc ## [1] 192.2719 ## ## $BIC ## [1] 196.9894 ## ## $Convergence ## NULL ## ## $Message ## [1] &quot;NEW_X&quot; ## ## $Prediction ## [1] 42.968908 42.670225 42.373971 41.497409 40.638979 ## [6] 39.798307 38.168774 36.605963 26.199969 15.864420 ## [11] 9.606111 5.816625 1.291342 2.517560 14.675410 ## [16] 25.184958 48.875096 63.953502 73.322753 82.001014 ## [21] 83.801867 63.124196 38.226373 23.146564 14.015543 ## [26] 3.111575 342.741791 550.276377 707.618692 1207.680518 ## ## $Residual ## [1] 4.5310916 3.5297754 4.1260287 1.4025914 5.2610212 ## [6] 5.0016932 2.3312257 1.3940374 0.1000309 -1.6644201 ## [11] -0.8061115 -0.1166247 0.2086579 -1.5775598 -1.5754103 ## [16] 2.7150415 -10.8750958 7.9464975 2.7772468 1.8989862 ## [21] -8.8018667 -11.5241957 -3.3263734 0.2534365 0.4844565 ## [26] 1.3884255 -2.7417910 -0.2763769 -2.6186923 2.3194822 ## ## $`Elapsed Time` ## Time difference of 0.2293859 secs wnl5(fPK06c, dPK06, pNames=c(&quot;V&quot;, &quot;Cl&quot;, &quot;fe&quot;, &quot;F&quot;, &quot;Ka&quot;, &quot;Tlag&quot;), IE=c(300, 5, 0.2, 0.9, 1, 0.4)) # require wnl_0.3.0 ## $PE ## V Cl fe F Ka ## 290.28502727 6.02550559 0.06982639 1.13591977 0.42038650 ## Tlag ## 0.31180912 ## ## $WRSS ## [1] 558.6177 ## ## $run ## $run$m ## [1] 11 ## ## $run$n ## [1] 19 ## ## $run$run ## [1] 11 ## ## $run$p.value ## [1] 0.08533426 ## ## ## $AIC ## [1] 201.764 ## ## $SBC ## [1] 210.1711 ## ## $`Condition Number` ## [1] 42117.4 ## ## $Convergence ## NULL ## ## $Message ## [1] &quot;NEW_X&quot; ## ## $Prediction ## [1] 42.7645069 42.4693145 42.1765098 41.3100669 40.4614237 ## [6] 39.6302143 38.0186719 36.4726621 26.1656565 15.8992960 ## [11] 9.6610460 5.8704367 1.3170710 0.8674253 13.5074832 ## [16] 24.3929637 48.7552624 64.0837819 73.4927938 82.0306988 ## [21] 83.6672079 62.9329358 38.2435205 23.2382877 14.1205100 ## [26] 3.1680291 342.4636649 550.5582398 707.2129441 1207.7503071 ## ## $Residual ## [1] 4.73549306 3.73068555 4.32349020 1.58993306 5.43857635 ## [6] 5.16978575 2.48132809 1.52733789 0.13434352 -1.69929595 ## [11] -0.86104604 -0.17043670 0.18292901 0.07257474 -0.40748320 ## [16] 3.50703627 -10.75526240 7.81621813 2.60720622 1.86930121 ## [21] -8.66720795 -11.33293581 -3.34352051 0.16171226 0.37948999 ## [26] 1.33197094 -2.46366489 -0.55823977 -2.21294410 2.24969295 ## ## $`Elapsed Time` ## Time difference of 0.1635621 secs "]
]
